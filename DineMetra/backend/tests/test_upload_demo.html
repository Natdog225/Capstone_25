<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DineMetra - Live CSV Upload Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">
            ðŸŽ¬ DineMetra Live Demo - CSV Upload
        </h1>

        <!-- Upload Zone -->
        <div id="dropZone" class="border-4 border-dashed border-gray-300 rounded-xl p-12 text-center bg-white hover:border-blue-400 transition-all cursor-pointer">
            <div id="uploadIdle">
                <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                <h2 class="text-2xl font-semibold text-gray-700 mb-2">Drop CSV Here</h2>
                <p class="text-gray-500 mb-4">or click to browse</p>
                <button class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                    Choose File
                </button>
                <p class="text-sm text-gray-400 mt-4">ðŸ’¡ Try: data/real/2025-02/02_Items.csv</p>
            </div>

            <div id="uploadProgress" class="hidden">
                <div class="animate-spin mx-auto h-12 w-12 border-4 border-blue-500 border-t-transparent rounded-full mb-4"></div>
                <h3 id="fileName" class="text-lg font-medium text-gray-700 mb-2"></h3>
                <p id="statusMessage" class="text-sm text-gray-600 mb-4"></p>
                <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                    <div id="progressBar" class="bg-blue-500 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="progressText" class="text-sm font-medium text-gray-700 mt-2">0%</p>
            </div>

            <div id="uploadSuccess" class="hidden">
                <svg class="mx-auto h-16 w-16 text-green-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3 class="text-2xl font-semibold text-green-700 mb-2">Upload Complete!</h3>
                <p id="successMessage" class="text-sm text-gray-600 mb-4"></p>
                <button onclick="reset()" class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                    Upload Another
                </button>
            </div>
        </div>

        <!-- Live Log -->
        <div class="mt-8 bg-white rounded-xl p-6 shadow-lg">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“¡ Live Updates</h3>
            <div id="liveLog" class="bg-gray-50 rounded-lg p-4 h-64 overflow-y-auto font-mono text-sm space-y-2"></div>
        </div>

        <input type="file" id="fileInput" accept=".csv" class="hidden">
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let ws = null;

        // Connect WebSocket
        function connectWebSocket() {
            ws = new WebSocket('ws://localhost:8000/ws/dashboard');
            
            ws.onopen = () => {
                addLog('ðŸŸ¢ Connected to server', 'text-green-600');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('WS:', data);

                if (data.type === 'upload_started') {
                    showUploadProgress();
                    document.getElementById('fileName').textContent = data.filename;
                    document.getElementById('statusMessage').textContent = data.message;
                    addLog(`ðŸ“¤ ${data.message}`, 'text-blue-600');
                } else if (data.type === 'upload_progress') {
                    updateProgress(data.progress, data.message);
                    addLog(`â³ ${data.message}`, 'text-gray-600');
                } else if (data.type === 'upload_complete') {
                    showSuccess(data.message);
                    addLog(`âœ… ${data.message}`, 'text-green-600');
                    setTimeout(() => {
                        addLog('ðŸ”„ Dashboard refreshing...', 'text-blue-600');
                    }, 1000);
                } else if (data.type === 'upload_error') {
                    addLog(`âŒ ${data.message}`, 'text-red-600');
                    reset();
                } else if (data.type === 'refresh_dashboard') {
                    addLog('âœ¨ Dashboard updated!', 'text-purple-600');
                }
            };

            ws.onclose = () => {
                addLog('ðŸ”´ Disconnected from server', 'text-red-600');
            };
        }

        function addLog(message, className = 'text-gray-700') {
            const log = document.getElementById('liveLog');
            const entry = document.createElement('div');
            entry.className = className;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function showUploadProgress() {
            document.getElementById('uploadIdle').classList.add('hidden');
            document.getElementById('uploadProgress').classList.remove('hidden');
            document.getElementById('uploadSuccess').classList.add('hidden');
        }

        function updateProgress(percent, message) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = percent + '%';
            document.getElementById('statusMessage').textContent = message;
        }

        function showSuccess(message) {
            document.getElementById('uploadProgress').classList.add('hidden');
            document.getElementById('uploadSuccess').classList.remove('hidden');
            document.getElementById('successMessage').textContent = message;
        }

        function reset() {
            document.getElementById('uploadIdle').classList.remove('hidden');
            document.getElementById('uploadProgress').classList.add('hidden');
            document.getElementById('uploadSuccess').classList.add('hidden');
            document.getElementById('progressBar').style.width = '0%';
        }

        async function uploadFile(file) {
            if (!file.name.endsWith('.csv')) {
                addLog('âŒ Please upload a CSV file', 'text-red-600');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_URL}/api/upload/upload-csv`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                console.log('Upload initiated:', result);
            } catch (error) {
                console.error('Upload error:', error);
                addLog(`âŒ Upload failed: ${error.message}`, 'text-red-600');
            }
        }

        // Drag & Drop
        const dropZone = document.getElementById('dropZone');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-500', 'bg-blue-50');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            const file = e.dataTransfer.files[0];
            if (file) uploadFile(file);
        });

        dropZone.addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) uploadFile(file);
        });

        // Connect on load
        connectWebSocket();
        addLog('ðŸš€ Demo ready! Upload a CSV file to begin.', 'text-blue-600');
    </script>
</body>
</html>
